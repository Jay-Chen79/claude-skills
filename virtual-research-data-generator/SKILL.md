---
name: virtual-research-data-generator
description: "生成用于教学和科研的高质量虚拟原始数据，支持多种研究类型，具备迭代验证功能。当用户提到'虚拟数据'、'模拟数据'、'生成数据'、'研究数据生成'、'RCT数据'、'教学数据'、'科研数据'、'虚拟原始数据'、'fake data'、'mock data'、'simulate data'、' synthetic data'等时使用此skill。特点：结果导向的迭代验证、确保数据符合预设效应方向和统计显著性、添加真实世界特征（缺失值/噪音/离群值）、支持RCT/队列/病例对照/横断面/诊断准确性/生存分析等多种研究类型。"
---

# Virtual Research Data Generator

## 概述

这是一个专门用于生成教学/科研用虚拟原始数据的Skill。核心功能是为科研教学场景生成**高质量的虚拟原始数据**。

生成的数据必须：
1. 具有真实世界数据的统计特性（分布、变异、缺失值模式等）
2. 符合用户预设的研究结论/效应方向
3. 经过统计验证确保数据与预期结果一致

> [!IMPORTANT]
> 这不是一个简单的随机数据生成器，而是一个**结果导向的、迭代验证的数据工程工具**。

---

## 核心工作流程

### 阶段一：初始化配置

在开始任何具体项目前，询问用户的全局偏好设置：

#### 运行模式
| 模式 | 说明 |
|-----|------|
| 快速模式 | 减少验证步骤，适合简单研究设计 |
| 严格模式 | 完整迭代验证，适合复杂研究或高要求场景 |

#### 边界条件
| 参数 | 默认值 |
|-----|--------|
| 最大变量数量 | 50 |
| 最大样本量 | 10000 |
| 最大迭代次数 | 20 |

#### 验证失败处理策略
当迭代达上限仍无法满足预期时：
- **选项A**：自动调整样本量并建议用户确认
- **选项B**：提示用户修改预期效应
- **选项C**：强制输出当前最优结果并附带详细警告
- **选项D**：让我每次遇到时再选择

#### 可复现性
- 是否保存随机种子以便复现（默认：是）

---

### 阶段二：需求收集

通过结构化问答收集信息，问题分批提出，每批3-5个问题。

#### 第一批：研究框架
1. 研究目的和假设（用一句话描述研究要验证什么）
2. 研究类型：
   - RCT（随机对照试验）
   - 队列研究（前瞻性/回顾性）
   - 病例对照研究
   - 横断面研究
   - 诊断准确性研究
   - 预后研究
   - 相关性/回归分析研究
   - 其他（请描述）
3. 大致的研究设计和方法

#### 第二批：样本与分组
1. 总样本量
2. 分组方式和各组样本量
3. 是否需要考虑失访/排除/缺失（如需要，预期比例）

#### 第三批：变量定义

对于每个变量，收集以下信息：

| 属性 | 说明 |
|-----|------|
| 变量名称 | 英文或中文均可 |
| 变量含义 | 简要描述该变量代表什么 |
| 变量类型 | 连续 / 二分类 / 无序分类 / 有序分类 / 计数 / 生存时间 |
| 变量角色 | 暴露(自变量) / 结局(因变量) / 协变量 / 混杂因素 / 效应修饰因素 |
| 合理范围 | 现实世界中该变量的正常范围 |
| 分布特征 | 正态/偏态/均匀/特定比例 |

**变量间关联性**（关键！）
- 哪些变量之间存在相关性
- 相关方向（正/负）和强度（强/中/弱，或具体r值）
- 是否存在混杂结构

#### 第四批：预期结果（最关键！）

**主要效应**
- 效应方向：正效应 / 负效应 / 无效应
- 效应量级：大/中/小，或定量值（如OR=2.0, HR=1.5, r=0.3等）
- 统计显著性：p<0.01 / p<0.05 / p=0.05-0.10 / p>0.10

**确认环节**
> "根据您的描述，我理解您需要生成的数据应该呈现以下结果：[总结预期结果]。是否正确？"

---

### 阶段三：数据架构设计

详见 [references/study_types.md](file://./references/study_types.md)

#### 3.1 变量关联矩阵
构建所有变量间的目标相关矩阵

#### 3.2 分布参数设定
详见 [references/distribution_params.md](file://./references/distribution_params.md)

#### 3.3 多变量生成策略

| 策略 | 适用场景 |
|-----|---------|
| 协方差矩阵法 | 连续变量为主 |
| 逐步条件生成 | 混合类型或复杂依赖结构 |
| 混合策略 | 核心变量+派生变量 |

#### 3.4 统计验证方案
详见 [references/statistical_methods.md](file://./references/statistical_methods.md)

---

### 阶段四：迭代数据生成与验证

这是本skill的核心特色——**生成→验证→调整**的闭环。

```
初始化迭代计数器 = 0
初始化最优结果记录

循环 {
    迭代计数器 += 1
    
    1. 【生成】根据当前参数生成原始数据
       - 如果启用可复现性，记录随机种子
    
    2. 【验证】对数据执行预设的统计分析
       - 计算主要效应指标
       - 计算置信区间
       - 计算p值
    
    3. 【评估】对比分析结果与预期结果
       - 效应方向是否正确？
       - 效应量是否在目标范围？（允许±20%浮动）
       - p值是否在目标范围？
       - 记录当前结果与目标的偏差程度
    
    4. 【决策】
       如果 所有验证指标通过：
           → 进入阶段五（真实性增强）
       
       如果 迭代次数 < 最大迭代次数 且 未通过：
           → 诊断偏差来源
           → 调整生成参数
           → 继续循环
       
       如果 迭代次数 >= 最大迭代次数 且 未通过：
           → 根据用户预设的失败处理策略执行
}
```

#### 参数调整策略

| 偏差类型 | 调整方向 |
|---------|---------|
| 效应过小 | 增大组间差异参数/增大相关系数 |
| 效应过大 | 减小组间差异参数/减小相关系数 |
| p值过大 | 减小组内变异/增大效应量/检查样本量 |
| p值过小 | 增大组内变异/减小效应量 |
| 效应方向错误 | 反转差异方向/检查参数符号 |

---

### 阶段五：真实性增强

#### 5.1 缺失值处理
- **MCAR**：完全随机缺失
- **MAR**：随机缺失（依赖其他观测变量）
- **MNAR**：非随机缺失（依赖缺失值本身）
- 默认：MCAR，2-5%

#### 5.2 数据噪音
- 连续变量：测量误差
- 分类变量：少量误分类（1-2%）

#### 5.3 离群值
- 添加1-3%合理离群值
- 范围：临床可能但罕见

#### 5.4 数据精度
- 根据测量特点四舍五入
- 确保精度与实际检测方法一致

#### 5.5 逻辑一致性检查
- ID唯一性
- 日期时间逻辑顺序
- 派生变量一致性
- 排除不可能值

---

### 阶段六：输出与交付

#### 必须输出

**1. 原始数据文件（Excel格式）**
```
数据文件.xlsx
├── Sheet 1: Raw_Data（原始数据）
├── Sheet 2: Data_Dictionary（数据字典）
└── Sheet 3: Summary_Statistics（汇总统计）
```

**2. 统计验证报告**
- 预期结果 vs 实际结果对比表
- 主要效应指标（点估计、95%CI、p值）
- 验证是否通过的结论

**3. 数据生成参数记录**
- 随机种子（如启用）
- 各变量生成参数
- 变量关联矩阵
- 迭代次数和最终验证结果

#### 可选输出
- 虚拟研究背景说明
- 变量关联可视化

---

## 脚本工具

本skill提供以下Python脚本辅助数据生成：

| 脚本 | 功能 |
|-----|------|
| [generate_continuous.py](file://./scripts/generate_continuous.py) | 连续变量生成 |
| [generate_categorical.py](file://./scripts/generate_categorical.py) | 分类变量生成 |
| [generate_survival.py](file://./scripts/generate_survival.py) | 生存数据生成 |
| [validate_statistics.py](file://./scripts/validate_statistics.py) | 统计验证 |
| [add_realism.py](file://./scripts/add_realism.py) | 真实性增强 |
| [export_excel.py](file://./scripts/export_excel.py) | Excel导出 |

---

## 研究类型特殊处理

详见 [references/study_types.md](file://./references/study_types.md)

| 研究类型 | 特殊考虑 |
|---------|---------|
| RCT | 基线平衡、ITT结构、CONSORT数字 |
| 队列研究 | 暴露组差异、失访模式、时间依赖暴露 |
| 病例对照 | 逆向设计、OR计算、匹配设计 |
| 横断面 | 同时点测量、患病率控制 |
| 诊断准确性 | 金标准、Se/Sp/AUC、阈值性能 |
| 生存分析 | 事件时间、删失、HR和生存曲线 |
| 回归/相关 | 相关系数、多重共线性控制 |

---

## 质量保证清单

### 统计验证
- [ ] 主效应方向正确
- [ ] 主效应量级在预期范围内（±20%）
- [ ] p值在预期显著性范围内
- [ ] 95%置信区间合理

### 数据结构
- [ ] 总样本量正确
- [ ] 各组样本量正确
- [ ] 所有预设变量均已包含
- [ ] 变量类型正确

### 真实性
- [ ] 连续变量分布合理
- [ ] 分类变量比例合理
- [ ] 缺失模式符合真实世界
- [ ] 存在合理的离群值

### 逻辑一致性
- [ ] 无不可能值
- [ ] 派生变量计算正确
- [ ] 时间顺序逻辑正确
- [ ] ID唯一

---

## 交互风格

1. **语言**：使用中文进行所有交互
2. **问题节奏**：分批提问，每批3-5个，避免信息过载
3. **术语处理**：对专业术语提供简要解释
4. **确认机制**：在关键决策点进行明确确认
5. **进度反馈**：迭代过程中报告进度和偏差情况
6. **问题处理**：统计上不可能的预期主动说明并提供替代建议

---

## 示例对话

```
【用户】我想生成一个RCT的虚拟数据

【Skill】好的，我来帮您生成RCT虚拟数据。首先，请确认几个全局设置：
1. 运行模式：快速模式 or 严格模式？
2. 如果数据迭代多次仍无法达到预期，您希望我：
   A. 建议调整样本量
   B. 请您修改预期效应
   C. 强制输出并警告
   D. 每次再问我

【用户】严格模式，选D

【Skill】收到。现在请告诉我：
1. 这个RCT要研究什么？（一句话描述研究假设）
2. 干预措施是什么？对照是什么？
3. 总样本量大约多少？两组如何分配？

...（后续交互）...

【Skill】开始生成数据...
第1次迭代：OSDI差异12.3分(p=0.002)，效应略大，调整参数...
第2次迭代：OSDI差异9.8分(p=0.018)，符合预期✓
验证泪膜破裂时间：差异2.1秒(p=0.031)，符合预期✓

数据生成完成！正在添加真实性细节...
```
